<template>
    <div class="fitness-module space-y-6">
        <!-- ä¸ªæ€§åŒ–ä¿¡æ¯é‡‡é›† -->
        <div class="bg-white border-2 border-[#0A0910] rounded-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-6 flex items-center gap-2">
                <span class="text-2xl">ğŸ’ª</span>
                å¡«å†™æ‚¨çš„ä¿¡æ¯å“¦ï¼
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="space-y-4">
                    <h4 class="font-bold text-gray-700 mb-3">åŸºæœ¬ä¿¡æ¯</h4>
                    
                    <!-- å¹´é¾„ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å¹´é¾„</label>
                        <input
                            v-model.number="profile.age"
                            type="number"
                            min="16"
                            max="100"
                            class="w-full px-3 py-2 border-2 border-[#0A0910] rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="è¯·è¾“å…¥å¹´é¾„"
                        />
                    </div>

                    <!-- æ€§åˆ« -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ€§åˆ«</label>
                        <select
                            v-model="profile.gender"
                            class="w-full px-3 py-2 border-2 border-[#0A0910] rounded-lg focus:outline-none focus:border-blue-500"
                        >
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="male">ç”·æ€§</option>
                            <option value="female">å¥³æ€§</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>

                    <!-- ä½“é‡ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä½“é‡ (kg)</label>
                        <input
                            v-model.number="profile.weight"
                            type="number"
                            min="30"
                            max="200"
                            step="0.1"
                            class="w-full px-3 py-2 border-2 border-[#0A0910] rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="è¯·è¾“å…¥ä½“é‡"
                        />
                    </div>

                    <!-- èº«é«˜ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">èº«é«˜ (cm)</label>
                        <input
                            v-model.number="profile.height"
                            type="number"
                            min="100"
                            max="250"
                            class="w-full px-3 py-2 border-2 border-[#0A0910] rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="è¯·è¾“å…¥èº«é«˜"
                        />
                    </div>
                </div>

                <!-- è¿åŠ¨ä¿¡æ¯ -->
                <div class="space-y-4">
                    <h4 class="font-bold text-gray-700 mb-3">è¿åŠ¨ä¿¡æ¯</h4>
                    
                    <!-- è¿åŠ¨é¢‘ç‡ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¿åŠ¨é¢‘ç‡</label>
                        <select
                            v-model="profile.exerciseFrequency"
                            class="w-full px-3 py-2 border-2 border-[#0A0910] rounded-lg focus:outline-none focus:border-blue-500"
                        >
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="rarely">å¾ˆå°‘è¿åŠ¨</option>
                            <option value="1-2_times">æ¯å‘¨1-2æ¬¡</option>
                            <option value="3-4_times">æ¯å‘¨3-4æ¬¡</option>
                            <option value="5+_times">æ¯å‘¨5æ¬¡ä»¥ä¸Š</option>
                        </select>
                    </div>

                    <!-- è¿åŠ¨å¼ºåº¦ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è¿åŠ¨å¼ºåº¦</label>
                        <select
                            v-model="profile.exerciseIntensity"
                            class="w-full px-3 py-2 border-2 border-[#0A0910] rounded-lg focus:outline-none focus:border-blue-500"
                        >
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="light">è½»åº¦è¿åŠ¨</option>
                            <option value="moderate">ä¸­åº¦è¿åŠ¨</option>
                            <option value="high">é«˜å¼ºåº¦è¿åŠ¨</option>
                            <option value="very_high">æé«˜å¼ºåº¦è¿åŠ¨</option>
                        </select>
                    </div>

                    <!-- å¥èº«ç›®æ ‡ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç»†åˆ†åœºæ™¯æ ‡ç­¾</label>
                        <select
                            v-model="profile.fitnessGoal"
                            class="w-full px-3 py-2 border-2 border-[#0A0910] rounded-lg focus:outline-none focus:border-blue-500"
                        >
                            <option value="">è¯·é€‰æ‹©</option>
                            <option value="muscle_gain">å¢è‚Œ</option>
                            <option value="fat_loss">å‡è„‚</option>
                            <option value="maintain">ç»´æŒä½“æ€</option>
                        </select>
                    </div>

                    <!-- æ¯æ—¥çƒ­é‡ç›®æ ‡ -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¯æ—¥çƒ­é‡ç›®æ ‡ (kcal)</label>
                        <input
                            v-model.number="profile.dailyCalorieGoal"
                            type="number"
                            min="1200"
                            max="5000"
                            step="50"
                            class="w-full px-3 py-2 border-2 border-[#0A0910] rounded-lg focus:outline-none focus:border-blue-500"
                            placeholder="è¯·è¾“å…¥æ¯æ—¥çƒ­é‡ç›®æ ‡"
                        />
                    </div>
                </div>
            </div>

            <!-- é¥®é£Ÿåå¥½ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                <div class="space-y-4">
                    <h4 class="font-bold text-gray-700 mb-3">é¥®é£Ÿåå¥½</h4>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">é¥®é£Ÿåå¥½ï¼ˆå¯å¤šé€‰ä¹Ÿå¯ä¸é€‰å“¦ï¼‰</label>
                        <div class="space-y-2">
                            <label v-for="pref in dietOptions" :key="pref.value" class="flex items-center gap-2">
                                <input
                                    type="checkbox"
                                    :value="pref.value"
                                    v-model="profile.dietPreference"
                                    class="w-4 h-4 text-blue-600 border-2 border-[#0A0910] rounded focus:outline-none focus:border-blue-500"
                                />
                                <span class="text-sm">{{ pref.label }}</span>
                            </label>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <h4 class="font-bold text-gray-700 mb-3">å£å‘³ä¸çƒ¹é¥ª</h4>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">åå¥½å£å‘³ï¼ˆå¯å¤šé€‰ä¹Ÿå¯ä¸é€‰å“¦ï¼‰</label>
                        <div class="space-y-2">
                            <label v-for="taste in tasteOptions" :key="taste.value" class="flex items-center gap-2">
                                <input
                                    type="checkbox"
                                    :value="taste.value"
                                    v-model="profile.tastePreference"
                                    class="w-4 h-4 text-blue-600 border-2 border-[#0A0910] rounded focus:outline-none focus:border-blue-500"
                                />
                                <span class="text-sm">{{ taste.label }}</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">çƒ¹é¥ªæ–¹å¼ï¼ˆå¯å¤šé€‰ä¹Ÿå¯ä¸é€‰å“¦ï¼‰</label>
                        <div class="space-y-2">
                            <label v-for="method in cookingOptions" :key="method.value" class="flex items-center gap-2">
                                <input
                                    type="checkbox"
                                    :value="method.value"
                                    v-model="profile.cookingMethod"
                                    class="w-4 h-4 text-blue-600 border-2 border-[#0A0910] rounded focus:outline-none focus:border-blue-500"
                                />
                                <span class="text-sm">{{ method.label }}</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¤æ¬¡é€‰æ‹© -->
        <div class="bg-white border-2 border-[#0A0910] rounded-lg p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">ğŸ½ï¸</span>
                é€‰æ‹©é¤æ¬¡
            </h3>
            
            <div class="flex flex-wrap gap-4">
                <label v-for="meal in mealOptions" :key="meal.value" class="flex items-center gap-2 cursor-pointer">
                    <input
                        type="checkbox"
                        :value="meal.value"
                        v-model="selectedMeals"
                        class="w-5 h-5 text-blue-600 border-2 border-[#0A0910] rounded focus:outline-none focus:border-blue-500"
                    />
                    <div>
                        <span class="font-medium text-gray-800">{{ meal.label }}</span>
                        <span class="text-sm text-gray-500">{{ meal.time }}</span>
                    </div>
                </label>
            </div>
        </div>

        <!-- ç”ŸæˆæŒ‰é’® -->
        <div class="text-center">
            <button
                @click="generateMeals"
                :disabled="!isFormValid || isLoading"
                class="bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 disabled:from-gray-400 disabled:to-gray-500 text-white px-8 py-4 rounded-lg font-bold border-2 border-[#0A0910] transition-all duration-200 transform hover:scale-105 disabled:scale-100 disabled:cursor-not-allowed text-lg"
            >
                <span v-if="isLoading" class="flex items-center gap-2">
                    <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                    æ­£åœ¨ç”Ÿæˆä¸­...
                </span>
                <span v-else class="flex items-center gap-2">
                    <span>âœ¨</span>
                    ç”Ÿæˆè¥å…»é¤
                </span>
            </button>
        </div>

        <!-- ç”Ÿæˆç»“æœ -->
        <div v-if="generatedMeals.length > 0" class="space-y-6">
            <div v-for="meal in generatedMeals" :key="meal.id" class="bg-white border-2 border-[#0A0910] rounded-lg overflow-hidden">
                <!-- é¤é£Ÿå¤´éƒ¨ -->
                <div class="bg-blue-100 border-b-2 border-[#0A0910] p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-lg font-bold text-gray-800">{{ meal.name }}</h4>
                            <p class="text-sm text-gray-600">{{ getMealTypeLabel(meal.type) }}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-sm text-gray-500">â±ï¸ {{ meal.cookingTime }}åˆ†é’Ÿ</span>
                            <span class="ml-2 text-sm text-gray-500">ğŸ“Š {{ getDifficultyLabel(meal.difficulty) }}</span>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    <p class="text-gray-700 mb-4">{{ meal.description }}</p>

                    <!-- é£Ÿæ -->
                    <div class="mb-6">
                        <h5 class="font-bold text-gray-800 mb-2">ğŸ¥¬ é£Ÿæ</h5>
                        <div class="flex flex-wrap gap-2">
                            <span v-for="ingredient in meal.ingredients" :key="ingredient" class="bg-yellow-400 text-dark-800 px-3 py-1 rounded-full text-sm font-medium border-2 border-[#0A0910]">
                                {{ ingredient }}
                            </span>
                        </div>
                    </div>

                    <!-- åˆ¶ä½œæ­¥éª¤ -->
                    <div class="mb-6">
                        <h5 class="font-bold text-gray-800 mb-2">ğŸ“ åˆ¶ä½œæ­¥éª¤</h5>
                        <div class="space-y-3">
                            <div v-for="(step, index) in meal.steps" :key="index" class="flex gap-3 p-3 bg-gray-50 rounded border-2 border-gray-200">
                                <div class="flex-shrink-0 w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-sm">
                                    {{ index + 1 }}
                                </div>
                                <p class="text-gray-700">{{ step }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- è¥å…»åˆ†æ -->
                    <div class="mb-6">
                        <h5 class="font-bold text-gray-800 mb-2">ğŸ“Š è¥å…»åˆ†æ</h5>
                        <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4">
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                <div><strong>çƒ­é‡:</strong> {{ meal.nutritionInfo.calories }} kcal</div>
                                <div><strong>è›‹ç™½è´¨:</strong> {{ meal.nutritionInfo.protein }}g</div>
                                <div><strong>ç¢³æ°´:</strong> {{ meal.nutritionInfo.carbs }}g</div>
                                <div><strong>è„‚è‚ª:</strong> {{ meal.nutritionInfo.fat }}g</div>
                                <div><strong>çº¤ç»´:</strong> {{ meal.nutritionInfo.fiber }}g</div>
                                <div v-if="meal.nutritionInfo.iron"><strong>é“:</strong> {{ meal.nutritionInfo.iron }}mg</div>
                                <div v-if="meal.nutritionInfo.calcium"><strong>é’™:</strong> {{ meal.nutritionInfo.calcium }}mg</div>
                            </div>
                        </div>
                    </div>

                    <!-- å·¥å…·ä½¿ç”¨ -->
                    <div v-if="meal.suitableTools && meal.suitableTools.length > 0" class="mb-6">
                        <h5 class="font-bold text-gray-800 mb-2">ğŸ”§ æ‰€éœ€å·¥å…·</h5>
                        <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4">
                            <div class="flex flex-wrap gap-2">
                                <span v-for="tool in meal.suitableTools" :key="tool" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium border-2 border-[#0A0910]">
                                    {{ tool }}
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- åˆ¶ä½œè´´å£« -->
                    <div v-if="meal.tips && meal.tips.length > 0">
                        <h5 class="font-bold text-gray-800 mb-2">ğŸ’¡ åˆ¶ä½œè´´å£«</h5>
                        <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4">
                            <ul class="space-y-2">
                                <li v-for="tip in meal.tips" :key="tip" class="flex items-start gap-2">
                                    <span class="text-yellow-600 mt-1">â€¢</span>
                                    <span class="text-gray-700">{{ tip }}</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue'
import type { FitnessProfile, GeneratedMeal, MealType } from '@/types'
import { generateNutritionMeals } from '@/services/precisionNutritionService'

const emit = defineEmits<{
    mealGenerated: [meal: GeneratedMeal]
}>()

// å¥èº«æ¡£æ¡ˆ
const profile = ref<FitnessProfile>({
    age: 0,
    gender: 'male',
    weight: 70,
    height: 170,
    exerciseFrequency: '3-4_times',
    exerciseIntensity: 'moderate',
    dietPreference: [],
    tastePreference: [],
    cookingMethod: [],
    dailyCalorieGoal: 2000,
    fitnessGoal: 'maintain'
})

// é€‰ä¸­çš„é¤æ¬¡
const selectedMeals = ref<MealType[]>(['breakfast', 'lunch', 'dinner'])

// ç”Ÿæˆçš„é¤é£Ÿ
const generatedMeals = ref<GeneratedMeal[]>([])
const isLoading = ref(false)

// é€‰é¡¹æ•°æ®
const dietOptions = [
    { value: 'balanced', label: 'å‡è¡¡é¥®é£Ÿ' },
    { value: 'high_protein', label: 'é«˜è›‹ç™½é¥®é£Ÿ' },
    { value: 'low_carb', label: 'ä½ç¢³æ°´é¥®é£Ÿ' },
    { value: 'low_fat', label: 'ä½è„‚é¥®é£Ÿ' },
    { value: 'vegetarian', label: 'ç´ é£Ÿä¸»ä¹‰' },
    { value: 'keto', label: 'ç”Ÿé…®é¥®é£Ÿ' }
]

const tasteOptions = [
    { value: 'sweet', label: 'ç”œå‘³' },
    { value: 'sour', label: 'é…¸å‘³' },
    { value: 'spicy', label: 'è¾£å‘³' },
    { value: 'salty', label: 'å’¸å‘³' },
    { value: 'light', label: 'æ¸…æ·¡' },
    { value: 'rich', label: 'æµ“éƒ' }
]

const cookingOptions = [
    { value: 'steaming', label: 'è’¸ç…®' },
    { value: 'boiling', label: 'æ°´ç…®' },
    { value: 'stir_frying', label: 'çˆ†ç‚’' },
    { value: 'baking', label: 'çƒ˜çƒ¤' },
    { value: 'grilling', label: 'çƒ§çƒ¤' },
    { value: 'salad', label: 'å‡‰æ‹Œ' }
]

const mealOptions = [
    { value: 'breakfast', label: 'æ—©é¤', time: '(6:00-9:00)' },
    { value: 'lunch', label: 'åˆé¤', time: '(11:00-14:00)' },
    { value: 'dinner', label: 'æ™šé¤', time: '(17:00-20:00)' }
]

// è¡¨å•éªŒè¯
const isFormValid = computed(() => {
    return profile.value.age > 0 &&
           profile.value.gender &&
           profile.value.weight > 0 &&
           profile.value.height > 0 &&
           profile.value.exerciseFrequency &&
           profile.value.exerciseIntensity &&
           profile.value.fitnessGoal &&
           profile.value.dailyCalorieGoal > 0 &&
           selectedMeals.value.length > 0
})

// ç”Ÿæˆé¤é£Ÿ
const generateMeals = async () => {
    if (!isFormValid.value) return

    isLoading.value = true
    
    try {
        // è°ƒç”¨çœŸå®çš„AIæœåŠ¡
        const meals = await generateNutritionMeals({
            profile: profile.value,
            mealTypes: selectedMeals.value,
            mode: 'fitness'
        })

        generatedMeals.value = meals
        
        // å‘é€äº‹ä»¶ç»™çˆ¶ç»„ä»¶
        meals.forEach(meal => {
            emit('mealGenerated', meal)
        })
        
    } catch (error) {
        console.error('ç”Ÿæˆå¥èº«é¤å¤±è´¥:', error)
        alert('ç”Ÿæˆè¥å…»é¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•')
    } finally {
        isLoading.value = false
    }
}

// è·å–é¤æ¬¡æ ‡ç­¾
const getMealTypeLabel = (type: MealType) => {
    const labels: Record<string, string> = {
        breakfast: 'æ—©é¤',
        lunch: 'åˆé¤', 
        dinner: 'æ™šé¤'
    }
    return labels[type] || type
}

// è·å–éš¾åº¦æ ‡ç­¾
const getDifficultyLabel = (difficulty: string) => {
    const labels: Record<string, string> = {
        easy: 'ç®€å•',
        medium: 'ä¸­ç­‰',
        hard: 'å›°éš¾'
    }
    return labels[difficulty] || difficulty
}
</script>

<style scoped>
.fitness-module {
    max-width: 56rem;
    margin-left: auto;
    margin-right: auto;
}

/* å¤é€‰æ¡†æ ·å¼ */
input[type="checkbox"]:checked {
    background-color: rgb(37 99 235);
    color: rgb(37 99 235);
    border-color: rgb(37 99 235);
}

/* ç§»é™¤é‡å¤çš„å¯¹å·æ˜¾ç¤º */
input[type="checkbox"]:checked::before {
    content: '';
}

/* åŠ è½½åŠ¨ç”» */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.animate-spin {
    animation: spin 1s linear infinite;
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .grid {
        grid-template-columns: repeat(1, minmax(0, 1fr));
        gap: 1rem;
    }
}
</style>